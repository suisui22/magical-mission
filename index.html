index.html

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é­”æ³•ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ - ãƒ¡ã‚¤ãƒ³</title>
<!--
  index.html
  - ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆ5æ®µéšï¼‰ï¼‹12å•ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼‹ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å­—å¹•(è‡ªå‹•å†ç”Ÿ)
  - æ–‡ç« ã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ç›´æ¥æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ã‚ã¨ã§HTMLã‚’ç·¨é›†ã—ã¦å¤‰æ›´ã§ãã¾ã™ã€‚
  - main stage ã®é€²è¡Œã‚„å¾—ç‚¹ã¯ localStorage ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
-->
<style>
:root{
  --bg1:#04030a;
  --accent:#b89cff;
  --card: rgba(255,255,255,0.06);
  --glassBlur: blur(6px);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Noto Serif JP", "Cinzel Decorative", serif;background: linear-gradient(180deg,#040414 0%, #000 70%);color:#f4f2ff}
body{padding-bottom:100px}

/* background magic circle (responsive, lightweight) */
.bg-svg{ position:fixed; left:50%; top:35%; transform:translate(-50%,-35%); width:80vw; height:80vw; max-width:900px; max-height:900px; opacity:0.08; z-index:0; pointer-events:none; animation:rot 120s linear infinite; }
@keyframes rot{from{transform:translate(-50%,-35%) rotate(0)} to{transform:translate(-50%,-35%) rotate(360deg)}}
@media (prefers-reduced-motion: reduce){ .bg-svg{animation:none} }

/* header */
.header{ position:sticky; top:0; z-index:3; background:rgba(4,4,10,0.75); backdrop-filter:var(--glassBlur); display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,0.03) }
.header h1{ margin:0; color:var(--accent); font-size:1.1rem; letter-spacing:1px}
.header .score{ font-weight:800; background:linear-gradient(90deg,#fff,#c7b4ff); -webkit-background-clip:text; background-clip:text; color:transparent; font-size:1rem; }

/* container */
.container{ position:relative; z-index:2; max-width:1100px; margin:18px auto; padding:0 14px; }

/* main mission area (prominent) */
.main-mission{
  background:var(--card); border:1px solid rgba(255,255,255,0.06); border-radius:14px; padding:14px; margin-bottom:16px; backdrop-filter:var(--glassBlur); box-shadow:0 10px 30px rgba(0,0,0,0.5)
}
.main-title{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.main-title h2{ margin:0; color:#fff; font-size:1.05rem }
.stage-tag{ background:linear-gradient(90deg,#ffd6a3,#c7b4ff); color:#2b004d; padding:6px 10px; border-radius:999px; font-weight:800; }

/* stage card */
.stage{
  background:rgba(255,255,255,0.03); border-radius:10px; padding:12px; margin-top:12px;
}
.stage h3{ margin:0 0 8px 0; color:#efe7ff }
.stage .desc{ opacity:0.9; margin-bottom:10px }

/* small input and button */
.kinput{ display:flex; gap:8px; align-items:center; }
.kinput input{ flex:1; padding:10px; min-height:44px; border-radius:10px; border:none; background:rgba(255,255,255,0.05); color:#fff; font-size:1rem }
.kinput button{ padding:10px 12px; min-height:44px; border-radius:10px; border:none; background:linear-gradient(90deg,#6f5bd8,#9e7cff); color:#fff; font-weight:800; cursor:pointer }

/* mini-missions row */
.mini-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:10px; margin-top:8px }
.mini{ background:rgba(255,255,255,0.04); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); display:flex; flex-direction:column; gap:8px }
.mini .title{ font-weight:800 }

/* normal missions area */
.section{ margin-top:18px }
.grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:12px; margin-top:12px }
.card{ background:rgba(255,255,255,0.04); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); display:flex; flex-direction:column; justify-content:space-between; min-height:120px }
.card h3{ margin:0 0 6px 0 }
.meta{ display:flex; justify-content:space-between; align-items:center; margin-top:8px }

/* story area (typewriter) */
.story-window{ margin-top:18px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,0.03); min-height:80px; position:relative; overflow:hidden }
.story-text{ font-size:0.98rem; line-height:1.6; white-space:pre-wrap; color:#f0eefc }
.story-img{ display:block; max-width:100%; margin:8px auto 0 auto; border-radius:8px }

/* hint floating button: moved to right-bottom and visible */
.hint{ position:fixed; right:12px; bottom:12px; z-index:5; background:linear-gradient(180deg,#fde7ff,#e6d7ff); color:#2b0057; padding:10px 12px; border-radius:999px; font-weight:800; text-decoration:none; box-shadow:0 8px 20px rgba(80,20,140,0.14) }

/* responsive tweaks */
@media (max-width:420px){
  .header h1{ font-size:1rem }
  .main-title{ flex-direction:column; align-items:flex-start; gap:8px }
}
</style>
</head>
<body>
  <!-- background svg -->
  <svg class="bg-svg" viewBox="0 0 600 600" aria-hidden="true"><defs><radialGradient id="g"><stop offset="0%" stop-color="#c9b3ff" stop-opacity="0.7"/><stop offset="100%" stop-color="#6f52c8" stop-opacity="0.0"/></radialGradient></defs><circle cx="300" cy="300" r="280" fill="url(#g)"></circle><g stroke="#fff" stroke-opacity="0.06" fill="none" stroke-width="2"><circle cx="300" cy="300" r="220"></circle><circle cx="300" cy="300" r="160"></circle><path d="M300 140 L300 460" /><path d="M140 300 L460 300" /><path d="M200 200 L400 400" /><path d="M200 400 L400 200" /></g></svg>

  <header class="header">
    <h1>é­”æ³•ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³</h1>
    <div class="score" id="totalScore">åˆè¨ˆå¾—ç‚¹ï¼š0ç‚¹</div>
  </header>

  <main class="container">
    <!-- Main Mission (prominent) -->
    <section class="main-mission" id="mainMission">
      <div class="main-title">
        <h2>â˜… ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³</h2>
        <div class="stage-tag" id="stageTag">Stage 1</div>
      </div>

      <!-- Stage content is injected by JS; HTML below are placeholders / editable text -->
      <div id="stageArea"></div>
    </section>

    <!-- Normal Missions (12) -->
    <section class="section">
      <h2 style="margin:0;color:#d8ccff">é€šå¸¸ãƒŸãƒƒã‚·ãƒ§ãƒ³</h2>
      <div class="grid" id="missionGrid"></div>
    </section>

    <!-- Story window: auto-play intro on load; also used for triggered story animations -->
    <section class="story-window" id="storyWindow" aria-live="polite">
      <div id="storyText" class="story-text"></div>
      <!-- optional image can be inserted into story via JS or edit below -->
      <!-- <img src="img/story-image.jpg" class="story-img" alt="æŒ¿çµµ"> -->
    </section>
  </main>

  <a class="hint" href="hint.html" target="_blank" rel="noopener noreferrer">ğŸ”® ãƒ’ãƒ³ãƒˆ</a>

<script>
/* ============================
  Data & Editable Text (HTMLå†…ã«ç›´æ¥ç½®ã„ã¦ã‚ã‚‹ã®ã§ç›´æ¥ç·¨é›†ã—ã¦OK)
  - ãƒŸãƒƒã‚·ãƒ§ãƒ³æ–‡ã‚„åˆè¨€è‘‰ã€å¾—ç‚¹ã¯ã“ã“ã§ç·¨é›†ã—ã¦ãã ã•ã„ã€‚
  - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ–‡ã‚‚ä¸‹ã®å¤‰æ•°ã§ç·¨é›†ã§ãã¾ã™ã€‚
============================ */
const NORMAL_MISSIONS = [
  { id:0, text:"å…‰ã®é­”æ³•ã‚’å”±ãˆã‚ˆ", answer:"ãƒ«ãƒŸãƒŠã‚¹", point:10 },
  { id:1, text:"é¢¨ã‚’æ“ã‚‹è¨€è‘‰ã‚’æ€ã„å‡ºã›", answer:"ã‚¼ãƒ•ã‚£ãƒ¼ãƒ«", point:8 },
  { id:2, text:"æ°´ã®ç²¾éœŠã«å‘¼ã³ã‹ã‘ã‚ˆ", answer:"ã‚¢ã‚¯ã‚¢ãƒªã‚¹", point:7 },
  { id:3, text:"ç‚ã‚’ç¯ã™å‘ªæ–‡ã‚’è¨€ãˆ", answer:"ã‚¤ã‚°ãƒŠã‚¤ãƒˆ", point:9 },
  { id:4, text:"æ™‚é–“ã‚’æ­¢ã‚ã‚‹è¨€è‘‰", answer:"ã‚¯ãƒ­ãƒã‚¹", point:12 },
  { id:5, text:"é‹å‘½ã®è¼ªã‚’å›ã›", answer:"ãƒ•ã‚©ãƒ¼ãƒãƒ¥ãƒŠ", point:11 },
  { id:6, text:"é—‡ã‚’æ‰•ã†ç¥ˆã‚Šã‚’å”±ãˆã‚ˆ", answer:"ãƒã‚¯ã‚¹", point:10 },
  { id:7, text:"çœŸå®Ÿã®æ‰‰ã‚’é–‹ã‘ã‚‹éµ", answer:"ãƒ´ã‚§ãƒªã‚¿ã‚¹", point:13 },
  { id:8, text:"å¤¢ã®å®ˆè­·è€…ã®åã‚’ç­”ãˆã‚ˆ", answer:"ã‚½ãƒ ãƒ‹ã‚¢", point:8 },
  { id:9, text:"æ˜Ÿã€…ã®æ­Œã‚’çŸ¥ã‚‹è€…", answer:"ã‚¹ãƒ†ãƒ©", point:9 },
  { id:10, text:"å¿ƒã®å£°ã‚’å½¢ã«ã›ã‚ˆ", answer:"ã‚¢ãƒ‹ãƒ", point:10 },
  { id:11, text:"æœ€å¾Œã®è©¦ç·´ã‚’è¶Šãˆã‚ˆ", answer:"ã‚¢ãƒ«ã‚«ãƒŠ", point:15 }
];

/* Main mission 5 mini-missions for stage1 (can edit these) */
const MAIN_STAGE1 = [
  { id: "m1_0", text:"ã€1ã€‘å°å°ã‚’è§£ãè¨€è‘‰ï¼ˆ1ï¼‰", answer:"ã‚¢ãƒ«ãƒ•ã‚¡", point:5 },
  { id: "m1_1", text:"ã€2ã€‘å°å°ã‚’è§£ãè¨€è‘‰ï¼ˆ2ï¼‰", answer:"ãƒ™ãƒ¼ã‚¿", point:5 },
  { id: "m1_2", text:"ã€3ã€‘å°å°ã‚’è§£ãè¨€è‘‰ï¼ˆ3ï¼‰", answer:"ã‚¬ãƒ³ãƒ", point:5 },
  { id: "m1_3", text:"ã€4ã€‘å°å°ã‚’è§£ãè¨€è‘‰ï¼ˆ4ï¼‰", answer:"ãƒ‡ãƒ«ã‚¿", point:5 },
  { id: "m1_4", text:"ã€5ã€‘å°å°ã‚’è§£ãè¨€è‘‰ï¼ˆ5ï¼‰", answer:"ã‚¤ãƒ—ã‚·ãƒ­ãƒ³", point:5 }
];

/* Story blocks: these are displayed with typewriter one after another.
   You can edit text directly here. */
const STORY_INTRO = `ã“ã‚“ã«ã¡ã¯è«¸å›ã€ã“ã¡ã‚‰ã¯é­”é“ç ”ç©¶ä¼šã€‚
ç§ãŸã¡ã®ç ”ç©¶ä¼šã§ã¯ç•°ä¸–ç•Œã®ç”Ÿãç‰©ã«ã¤ã„ã¦è‰²ã€…èªã‚‹è‡³ã£ã¦æ™®é€šã®ç ”ç©¶ä¼šã ã£ãŸã€‚â€¦â€¦ã“ã®é–“ã¾ã§ã¯ã€‚
å®Ÿã¯å…ˆæ—¥ã€ç†±æ„ã®ã‚ã‚‹ã‚‚ã®ãŒç•°ä¸–ç•Œã®ç”Ÿãç‰©ã‚’å‘¼ã³å‡ºã—ã¦ã—ã¾ã„ã€æœ¬å½“ã«å¤§é˜ªèŠ¸å¤§ã«ç•°ä¸–ç•Œã®ç”Ÿãç‰©ãŒå¬å–šã•ã‚Œã¦ã—ã¾ã£ãŸã®ã ã€‚
ãã‚“ãªæ™‚ã«ã¡ã‚‡ã†ã©å­¦åœ’ç¥­ãŒè¡Œã‚ã‚Œã‚‹ã“ã¨ã«ãªã£ãŸã®ã§å¤§é˜ªèŠ¸å¤§å‘¨éŠè¬ã¨éŠ˜æ‰“ã£ã¦ã€é ­ã®è‰¯ã„å›ãŸã¡ã«åŠ©ã‘ã‚’æ±‚ã‚ãŸã®ã ã€‚
`;

/* Additional story blocks for main mission progression.
   Stage 1 completion -> show BLOCK_AFTER_STAGE1, then allow stage2 keyword input, etc.
   Edit these to change narrative. */
const BLOCK_AFTER_STAGE1 = `ç•°ç•Œã®æ°—é…ã¯æ¿ƒããªã£ãŸã€‚
å›ãŸã¡ã®æ‰‹éš›ã¯è‰¯ã‹ã£ãŸã€‚æ¬¡ã®æ‰‹ãŒã‹ã‚Šã¯å¤ã„æ›¸ç‰©ã«ã‚ã‚‹ã¨ã„ã†å™‚ã ã€‚
ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘å‡ºã›ã€‚`;

/* Stage2 correct -->
   Story when stage2 keyword is correct */
const BLOCK_STAGE2_CORRECT = `æ›¸ç‰©ã®ãƒšãƒ¼ã‚¸ãŒä¸€æšã‚ãã‚Œã€å¤ã®æ–‡å­—ãŒå…‰ã£ãŸã€‚
å›ãŸã¡ã¯æ¬¡ã®æ‰‰ã‚’é–‹ã‘ã‚‹è³‡æ ¼ã‚’å¾—ãŸã€‚ã•ã‚‰ã«æ·±ã„å ´æ‰€ã¸é€²ã‚€ãŒã‚ˆã„ã€‚`;

/* Stage3 correct -->
   Another story */
const BLOCK_STAGE3_CORRECT = `æ·±æ·µã®å£°ãŒå›ãã€‚ã‚‚ã†ã™ãæ ¸å¿ƒã«åˆ°é”ã™ã‚‹ã€‚
æœ€å¾Œã®éµã‚’è¦‹ã¤ã‘ã€ãã—ã¦çœŸå®Ÿã‚’çŸ¥ã‚Œã€‚`;

/* Stage4 video trigger (after correct keyword) - we will show a placeholder video then move to stage5 */
const BLOCK_STAGE4_AFTER_VIDEO = `æ˜ åƒãŒçµ‚ã‚ã£ãŸã€‚
æ˜ åƒã®ä¸­ã«ã€æœ€å¾Œã®ãƒ’ãƒ³ãƒˆãŒæ®‹ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã ã€‚`;

/* Stage5 final story */
const BLOCK_STAGE5_CORRECT = `å›ãŸã¡ã®æ´»èºã«ã‚ˆã‚Šã€å¹³ç©ãŒæˆ»ã£ãŸã€‚
ç ”ç©¶ä¼šã¯é™ã‹ã«æ¯ã‚’åãã€å›ãŸã¡ã¯ä¼èª¬ã¨ãªã‚‹ã€‚ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼`;

/* ============================
  localStorage keys & helpers
============================ */
const TOTAL_KEY = "total_score";
const MISSION_SOLVED_PREFIX = "mission_"; // mission_{id}_solved
const MAIN_STAGE_KEY = "main_stage"; // number 1..5
const MAIN_STAGE1_FLAGS = "main_stage1_flags"; // JSON map of solved mini missions
const MAIN_STAGE_SOLVED_PREFIX = "main_stage_solved_"; // e.g. main_stage_solved_2 true

function getTotal(){ const v = parseInt(localStorage.getItem(TOTAL_KEY)); return Number.isNaN(v)?0:v }
function setTotal(v){ localStorage.setItem(TOTAL_KEY, String(v)); renderTotal() }
function markNormalSolved(id){ localStorage.setItem(MISSION_SOLVED_PREFIX + id + "_solved","true") }
function isNormalSolved(id){ return localStorage.getItem(MISSION_SOLVED_PREFIX + id + "_solved")==="true" }

function getMainStage(){ const s = parseInt(localStorage.getItem(MAIN_STAGE_KEY)); return Number.isNaN(s)?1:s }
function setMainStage(n){ localStorage.setItem(MAIN_STAGE_KEY,String(n)); renderStage(); }

/* stage1 flags */
function getStage1Flags(){ try{ return JSON.parse(localStorage.getItem(MAIN_STAGE1_FLAGS)) || {} }catch(e){ return {} } }
function setStage1Flag(key, val){ const f = getStage1Flags(); f[key]=val; localStorage.setItem(MAIN_STAGE1_FLAGS, JSON.stringify(f)); renderStage(); }
function isStage1AllSolved(){ const f = getStage1Flags(); return MAIN_STAGE1.every(m=> f[m.id]===true) }

/* render functions */
const totalScoreEl = document.getElementById("totalScore");
function renderTotal(){ totalScoreEl.textContent = `åˆè¨ˆå¾—ç‚¹ï¼š${getTotal()}ç‚¹` }
renderTotal();

/* render normal missions */
function renderNormalMissions(){
  const grid = document.getElementById("missionGrid");
  grid.innerHTML = "";
  NORMAL_MISSIONS.forEach(m=>{
    const card = document.createElement("div"); card.className="card";
    card.innerHTML = `
      <div>
        <h3>ãƒŸãƒƒã‚·ãƒ§ãƒ³ ${m.id+1}</h3>
        <p>${m.text}</p>
      </div>
      <div class="meta">
        <div class="point">${m.point} ç‚¹</div>
        <div style="display:flex; gap:8px; align-items:center">
          <div id="normalSolved_${m.id}">${isNormalSolved(m.id) ? "âœ… æ­£è§£æ¸ˆ" : ""}</div>
          <button class="btn" data-id="${m.id}" style="padding:8px 10px; min-height:40px">æŒ‘æˆ¦</button>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
  // attach handlers
  document.querySelectorAll(".card .btn").forEach(b=>{
    b.addEventListener("click", (e)=>{
      const id = b.getAttribute("data-id");
      location.href = `mission.html?id=${encodeURIComponent(id)}`;
    });
  });
}
renderNormalMissions();

/* ============================
  Main mission rendering & logic
============================ */
const stageArea = document.getElementById("stageArea");
const stageTag = document.getElementById("stageTag");
function renderStage(){
  const s = getMainStage();
  stageTag.textContent = `Stage ${s}`;
  stageArea.innerHTML = ""; // clear
  if(s===1){
    renderStage1();
  } else if(s===2){
    renderStage2();
  } else if(s===3){
    renderStage3();
  } else if(s===4){
    renderStage4();
  } else if(s===5){
    renderStage5();
  }
}

/* Stage1: show 5 mini-missions with input & check. When all 5 solved => play story block and advance to stage2 */
function renderStage1(){
  const container = document.createElement("div");
  container.className = "stage";
  container.innerHTML = `<h3>ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç¬¬1æ®µéšï¼‰ â€” å°å°ã‚’è§£ã‘</h3><div class="desc">ä»¥ä¸‹ã®5ã¤ã®è¨€è‘‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å…¨ã¦æ­£è§£ã§æ¬¡ã¸é€²ã¿ã¾ã™ã€‚</div>`;
  const miniGrid = document.createElement("div"); miniGrid.className="mini-grid";
  MAIN_STAGE1.forEach(m=>{
    const box = document.createElement("div"); box.className="mini";
    const solvedFlag = getStage1Flags()[m.id]===true;
    box.innerHTML = `
      <div class="title">${m.text}</div>
      <div>å¾—ç‚¹: ${m.point} ç‚¹</div>
      <input type="text" id="in_${m.id}" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›" style="padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.04); color:#fff">
      <div style="display:flex; gap:8px; margin-top:6px">
        <button data-id="${m.id}" class="mini-check" style="padding:8px 10px; min-height:40px">åˆ¤å®š</button>
        <div id="mini_res_${m.id}" style="align-self:center">${solvedFlag? "âœ… æ­£è§£æ¸ˆ": ""}</div>
      </div>
    `;
    miniGrid.appendChild(box);
  });
  container.appendChild(miniGrid);
  stageArea.appendChild(container);

  // attach handlers
  document.querySelectorAll(".mini-check").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const m = MAIN_STAGE1.find(x=>x.id===id);
      const val = document.getElementById("in_"+id).value.trim();
      if(val === m.answer){
        // mark solved
        const prevFlags = getStage1Flags();
        if(prevFlags[id] !== true){
          // award points for main stage1 mini-missions too
          setTotal(getTotal() + m.point);
        }
        setStage1Flag(id, true);
        document.getElementById("mini_res_"+id).textContent = "âœ… æ­£è§£æ¸ˆ";
        // if all solved -> advance after playing story
        if(isStage1AllSolved()){
          // play story after short delay
          playStorySequence([BLOCK_AFTER_STAGE1], ()=> {
            // advance to stage2
            setMainStage(2);
          });
        }
      } else {
        // show small temporary message under input
        const resEl = document.getElementById("mini_res_"+id);
        resEl.textContent = "ä½•ã‹ãŒé•ã†ã‚ˆã†ã§ã™ã€‚";
        setTimeout(()=>{ if(getStage1Flags()[id]!==true) resEl.textContent = "" }, 1800);
      }
    });
  });
}

/* Stage2: show overview, then keyword input; on correct -> play BLOCK_STAGE2_CORRECT then advance to stage3 */
function renderStage2(){
  const container = document.createElement("div"); container.className="stage";
  container.innerHTML = `
    <h3>ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç¬¬2æ®µéšï¼‰ â€” å¤æ›¸ã®è¬</h3>
    <div class="desc">å…ˆç¨‹ã®æ‰‹ãŒã‹ã‚Šã‚’å…ƒã«ã€å¤æ›¸ã®ãƒšãƒ¼ã‚¸ã«è¨˜ã•ã‚ŒãŸã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
    <div style="margin-top:10px" id="stage2Area">
      <div class="kinput">
        <input id="kw2" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        <button id="kw2Btn">åˆ¤å®š</button>
      </div>
      <div id="kw2Res" style="margin-top:8px;color:#ffd6d6"></div>
    </div>
  `;
  stageArea.appendChild(container);
  document.getElementById("kw2Btn").addEventListener("click", ()=>{
    const val = document.getElementById("kw2").value.trim();
    const CORRECT = "ã‚ªãƒ«ãƒã‚¹"; // <-- ã“ã“ã‚’å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰
    if(val === CORRECT){
      // award small points and play story then advance
      if(!localStorage.getItem(MAIN_STAGE_SOLVED_PREFIX + "2")){
        setTotal(getTotal() + 25);
        localStorage.setItem(MAIN_STAGE_SOLVED_PREFIX + "2","true");
      }
      playStorySequence([BLOCK_STAGE2_CORRECT], ()=>{ setMainStage(3); });
    } else {
      document.getElementById("kw2Res").textContent = "ä½•ã‹ãŒé•ã†ã‚ˆã†ã§ã™ã€‚";
      setTimeout(()=>document.getElementById("kw2Res").textContent = "",1500);
    }
  });
}

/* Stage3: keyword input => story => stage4 */
function renderStage3(){
  const container = document.createElement("div"); container.className="stage";
  container.innerHTML = `
    <h3>ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç¬¬3æ®µéšï¼‰ â€” æ·±æ·µã®å›ã</h3>
    <div class="desc">ã“ã“ã§ã¯çŸ­ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
    <div class="kinput" style="margin-top:10px">
      <input id="kw3" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      <button id="kw3Btn">åˆ¤å®š</button>
    </div>
    <div id="kw3Res" style="margin-top:8px;color:#ffd6d6"></div>
  `;
  stageArea.appendChild(container);
  document.getElementById("kw3Btn").addEventListener("click", ()=>{
    const val = document.getElementById("kw3").value.trim();
    const CORRECT = "ãƒ«ãƒŸã‚¢"; // <-- ç·¨é›†å¯
    if(val === CORRECT){
      if(!localStorage.getItem(MAIN_STAGE_SOLVED_PREFIX + "3")){
        setTotal(getTotal() + 30);
        localStorage.setItem(MAIN_STAGE_SOLVED_PREFIX + "3","true");
      }
      playStorySequence([BLOCK_STAGE3_CORRECT], ()=>{ setMainStage(4); });
    } else {
      document.getElementById("kw3Res").textContent = "ä½•ã‹ãŒé•ã†ã‚ˆã†ã§ã™ã€‚";
      setTimeout(()=>document.getElementById("kw3Res").textContent = "",1500);
    }
  });
}

/* Stage4: keyword -> play video -> stage5 */
function renderStage4(){
  const container = document.createElement("div"); container.className="stage";
  container.innerHTML = `
    <h3>ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç¬¬4æ®µéšï¼‰ â€” æ˜ åƒã®è§£èª­</h3>
    <div class="desc">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ç‰¹åˆ¥ãªæ˜ åƒãŒå†ç”Ÿã•ã‚Œã¾ã™ã€‚</div>
    <div style="margin-top:10px" id="stage4Area">
      <div class="kinput">
        <input id="kw4" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        <button id="kw4Btn">åˆ¤å®š</button>
      </div>
      <div id="kw4Res" style="margin-top:8px;color:#ffd6d6"></div>
      <div id="videoWrap" style="margin-top:12px; display:none">
        <!-- ãƒ’ãƒ³ãƒˆç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«å‹•ç”»ãŒã‚ã‚‹å ´åˆã«ã¯ /video/your.mp4 ã‚’é…ç½®ã—ã¦ãã ã•ã„ -->
        <video id="mainVideo" controls playsinline style="width:100%; border-radius:8px; background:#000">
          <source src="video/sample.mp4" type="video/mp4">
          <!-- ãƒ­ãƒ¼ã‚«ãƒ«ã«å‹•ç”»ãŒãªã„å ´åˆã€å‹•ç”»ã¯å†ç”Ÿã•ã‚Œãšä»£ã‚ã‚Šã«storyè¡¨ç¤ºã‚’è¡Œã„ã¾ã™ -->
          å‹•ç”»ã‚’å†ç”Ÿã§ãã¾ã›ã‚“ã€‚
        </video>
      </div>
    </div>
  `;
  stageArea.appendChild(container);
  document.getElementById("kw4Btn").addEventListener("click", ()=>{
    const val = document.getElementById("kw4").value.trim();
    const CORRECT = "ã‚·ã‚°ãƒ"; // <-- ç·¨é›†å¯
    if(val === CORRECT){
      if(!localStorage.getItem(MAIN_STAGE_SOLVED_PREFIX + "4")){
        setTotal(getTotal() + 40);
        localStorage.setItem(MAIN_STAGE_SOLVED_PREFIX + "4","true");
      }
      // show video area and autoplay if source exists
      const wrap = document.getElementById("videoWrap");
      const vid = document.getElementById("mainVideo");
      wrap.style.display = "block";
      // try to play (if video file exists)
      vid.play().catch(()=> {
        // fallback: if video can't play (no file), just show story block then advance
        playStorySequence([BLOCK_STAGE4_AFTER_VIDEO], ()=> setMainStage(5));
      });
      // when video ends, advance to stage5
      vid.onended = () => {
        playStorySequence([BLOCK_STAGE4_AFTER_VIDEO], ()=> setMainStage(5));
      };
    } else {
      document.getElementById("kw4Res").textContent = "ä½•ã‹ãŒé•ã†ã‚ˆã†ã§ã™ã€‚";
      setTimeout(()=>document.getElementById("kw4Res").textContent = "",1500);
    }
  });
}

/* Stage5: video replay and final keyword -> final story -> complete.html */
function renderStage5(){
  const container = document.createElement("div"); container.className="stage";
  container.innerHTML = `
    <h3>ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç¬¬5æ®µéšï¼‰ â€” çœŸå®Ÿã®é¡•ç¾</h3>
    <div class="desc">å…ˆç¨‹æµã‚ŒãŸæ˜ åƒã‚’å†ç”Ÿã§ãã¾ã™ã€‚æ¦‚è¦ã‚‚ç¢ºèªã—ã€æœ€å¾Œã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
    <div style="margin-top:10px">
      <div style="margin-bottom:10px; font-weight:700">æ¦‚è¦ï¼šæ˜ åƒã®ä¸­ã«ã‚ã‚‹ã€Œæœ€å¾Œã®å°ã€ã‚’è¦‹ã¤ã‘ã‚ˆã€‚</div>
      <div style="margin-top:6px"><video id="replayVideo" controls playsinline style="width:100%; border-radius:8px"><source src="video/sample.mp4" type="video/mp4">å‹•ç”»ãŒã‚ã‚Šã¾ã›ã‚“</video></div>
      <div style="margin-top:12px" class="kinput"><input id="kw5" placeholder="æœ€çµ‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"><button id="kw5Btn">åˆ¤å®š</button></div>
      <div id="kw5Res" style="margin-top:8px;color:#ffd6d6"></div>
    </div>
  `;
  stageArea.appendChild(container);
  document.getElementById("kw5Btn").addEventListener("click", ()=>{
    const val = document.getElementById("kw5").value.trim();
    const CORRECT = "ã‚ªãƒ¡ã‚¬"; // <-- ç·¨é›†å¯
 function setStage1Flag(key, val){ const f = getStage1Flags(); f[key]=val; localStorage.setItem(MAIN_STAGE1_FLAGS, JSON.stringify(f)); renderStage(); }
function isStage1AllSolved(){ const f = getStage1Flags(); return MAIN_STAGE1.every(m=> f[m.id]===true) }

/* render functions */
const totalScoreEl = document.getElementById("totalScore");
function renderTotal(){ totalScoreEl.textContent = `åˆè¨ˆå¾—ç‚¹ï¼š${getTotal()}ç‚¹` }
renderTotal();

/* render normal missions */
function renderNormalMissions(){
  const grid = document.getElementById("missionGrid");
  grid.innerHTML = "";
  NORMAL_MISSIONS.forEach(m=>{
    const card = document.createElement("div"); card.className="card";
    card.innerHTML = `
      <div>
        <h3>ãƒŸãƒƒã‚·ãƒ§ãƒ³ ${m.id+1}</h3>
        <p>${m.text}</p>
      </div>
      <div class="meta">
        <div class="point">${m.point} ç‚¹</div>
        <div style="display:flex; gap:8px; align-items:center">
          <div id="normalSolved_${m.id}">${isNormalSolved(m.id) ? "âœ… æ­£è§£æ¸ˆ" : ""}</div>
          <button class="btn" data-id="${m.id}" style="padding:8px 10px; min-height:40px">æŒ‘æˆ¦</button>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
  // attach handlers
  document.querySelectorAll(".card .btn").forEach(b=>{
    b.addEventListener("click", (e)=>{
      const id = b.getAttribute("data-id");
      location.href = `mission.html?id=${encodeURIComponent(id)}`;
    });
  });
}
renderNormalMissions();

/* ============================
  Main mission rendering & logic
============================ */
const stageArea = document.getElementById("stageArea");
const stageTag = document.getElementById("stageTag");
function renderStage(){
  const s = getMainStage();
  stageTag.textContent = `Stage ${s}`;
  stageArea.innerHTML = ""; // clear
  if(s===1){
    renderStage1();
  } else if(s===2){
    renderStage2();
  } else if(s===3){
    renderStage3();
  } else if(s===4){
    renderStage4();
  } else if(s===5){
    renderStage5();
  }
}

/* Stage1: show 5 mini-missions with input & check. When all 5 solved => play story block and advance to stage2 */
function renderStage1(){
  const container = document.createElement("div");
  container.className = "stage";
  container.innerHTML = `<h3>ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç¬¬1æ®µéšï¼‰ â€” å°å°ã‚’è§£ã‘</h3><div class="desc">ä»¥ä¸‹ã®5ã¤ã®è¨€è‘‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å…¨ã¦æ­£è§£ã§æ¬¡ã¸é€²ã¿ã¾ã™ã€‚</div>`;
  const miniGrid = document.createElement("div"); miniGrid.className="mini-grid";
  MAIN_STAGE1.forEach(m=>{
    const box = document.createElement("div"); box.className="mini";
    const solvedFlag = getStage1Flags()[m.id]===true;
    box.innerHTML = `
      <div class="title">${m.text}</div>
      <div>å¾—ç‚¹: ${m.point} ç‚¹</div>
      <input type="text" id="in_${m.id}" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›" style="padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.04); color:#fff">
      <div style="display:flex; gap:8px; margin-top:6px">
        <button data-id="${m.id}" class="mini-check" style="padding:8px 10px; min-height:40px">åˆ¤å®š</button>
        <div id="mini_res_${m.id}" style="align-self:center">${solvedFlag? "âœ… æ­£è§£æ¸ˆ": ""}</div>
      </div>
    `;
    miniGrid.appendChild(box);
  });
  container.appendChild(miniGrid);
  stageArea.appendChild(container);

  // attach handlers
  document.querySelectorAll(".mini-check").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const m = MAIN_STAGE1.find(x=>x.id===id);
      const val = document.getElementById("in_"+id).value.trim();
      if(val === m.answer){
        // mark solved
        const prevFlags = getStage1Flags();
        if(prevFlags[id] !== true){
          // award points for main stage1 mini-missions too
          setTotal(getTotal() + m.point);
        }
        setStage1Flag(id, true);
        document.getElementById("mini_res_"+id).textContent = "âœ… æ­£è§£æ¸ˆ";
        // if all solved -> advance after playing story
        if(isStage1AllSolved()){
          // play story after short delay
          playStorySequence([BLOCK_AFTER_STAGE1], ()=> {
            // advance to stage2
            setMainStage(2);
          });
        }
      } else {
        // show small temporary message under input
        const resEl = document.getElementById("mini_res_"+id);
        resEl.textContent = "ä½•ã‹ãŒé•ã†ã‚ˆã†ã§ã™ã€‚";
        setTimeout(()=>{ if(getStage1Flags()[id]!==true) resEl.textContent = "" }, 1800);
      }
    });
  });
}

/* Stage2: show overview, then keyword input; on correct -> play BLOCK_STAGE2_CORRECT then advance to stage3 */
function renderStage2(){
  const container = document.createElement("div"); container.className="stage";
  container.innerHTML = `
    <h3>ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç¬¬2æ®µéšï¼‰ â€” å¤æ›¸ã®è¬</h3>
    <div class="desc">å…ˆç¨‹ã®æ‰‹ãŒã‹ã‚Šã‚’å…ƒã«ã€å¤æ›¸ã®ãƒšãƒ¼ã‚¸ã«è¨˜ã•ã‚ŒãŸã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
    <div style="margin-top:10px" id="stage2Area">
      <div class="kinput">
        <input id="kw2" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        <button id="kw2Btn">åˆ¤å®š</button>
      </div>
      <div id="kw2Res" style="margin-top:8px;color:#ffd6d6"></div>
    </div>
  `;
  stageArea.appendChild(container);
  document.getElementById("kw2Btn").addEventListener("click", ()=>{
    const val = document.getElementById("kw2").value.trim();
    const CORRECT = "ã‚ªãƒ«ãƒã‚¹"; // <-- ã“ã“ã‚’å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰
    if(val === CORRECT){
      // award small points and play story then advance
      if(!localStorage.getItem(MAIN_STAGE_SOLVED_PREFIX + "2")){
        setTotal(getTotal() + 25);
        localStorage.setItem(MAIN_STAGE_SOLVED_PREFIX + "2","true");
      }
      playStorySequence([BLOCK_STAGE2_CORRECT], ()=>{ setMainStage(3); });
    } else {
      document.getElementById("kw2Res").textContent = "ä½•ã‹ãŒé•ã†ã‚ˆã†ã§ã™ã€‚";
      setTimeout(()=>document.getElementById("kw2Res").textContent = "",1500);
    }
  });
}

/* Stage3: keyword input => story => stage4 */
function renderStage3(){
  const container = document.createElement("div"); container.className="stage";
  container.innerHTML = `
    <h3>ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç¬¬3æ®µéšï¼‰ â€” æ·±æ·µã®å›ã</h3>
    <div class="desc">ã“ã“ã§ã¯çŸ­ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
    <div class="kinput" style="margin-top:10px">
      <input id="kw3" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      <button id="kw3Btn">åˆ¤å®š</button>
    </div>
    <div id="kw3Res" style="margin-top:8px;color:#ffd6d6"></div>
  `;
  stageArea.appendChild(container);
  document.getElementById("kw3Btn").addEventListener("click", ()=>{
    const val = document.getElementById("kw3").value.trim();
    const CORRECT = "ãƒ«ãƒŸã‚¢"; // <-- ç·¨é›†å¯
    if(val === CORRECT){
      if(!localStorage.getItem(MAIN_STAGE_SOLVED_PREFIX + "3")){
        setTotal(getTotal() + 30);
        localStorage.setItem(MAIN_STAGE_SOLVED_PREFIX + "3","true");
      }
      playStorySequence([BLOCK_STAGE3_CORRECT], ()=>{ setMainStage(4); });
    } else {
      document.getElementById("kw3Res").textContent = "ä½•ã‹ãŒé•ã†ã‚ˆã†ã§ã™ã€‚";
      setTimeout(()=>document.getElementById("kw3Res").textContent = "",1500);
    }
  });
}

/* Stage4: keyword -> play video -> stage5 */
function renderStage4(){
  const container = document.createElement("div"); container.className="stage";
  container.innerHTML = `
    <h3>ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç¬¬4æ®µéšï¼‰ â€” æ˜ åƒã®è§£èª­</h3>
    <div class="desc">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ç‰¹åˆ¥ãªæ˜ åƒãŒå†ç”Ÿã•ã‚Œã¾ã™ã€‚</div>
    <div style="margin-top:10px" id="stage4Area">
      <div class="kinput">
        <input id="kw4" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        <button id="kw4Btn">åˆ¤å®š</button>
      </div>
      <div id="kw4Res" style="margin-top:8px;color:#ffd6d6"></div>
      <div id="videoWrap" style="margin-top:12px; display:none">
        <!-- ãƒ’ãƒ³ãƒˆç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«å‹•ç”»ãŒã‚ã‚‹å ´åˆã«ã¯ /video/your.mp4 ã‚’é…ç½®ã—ã¦ãã ã•ã„ -->
        <video id="mainVideo" controls playsinline style="width:100%; border-radius:8px; background:#000">
          <source src="video/sample.mp4" type="video/mp4">
          <!-- ãƒ­ãƒ¼ã‚«ãƒ«ã«å‹•ç”»ãŒãªã„å ´åˆã€å‹•ç”»ã¯å†ç”Ÿã•ã‚Œãšä»£ã‚ã‚Šã«storyè¡¨ç¤ºã‚’è¡Œã„ã¾ã™ -->
          å‹•ç”»ã‚’å†ç”Ÿã§ãã¾ã›ã‚“ã€‚
        </video>
      </div>
    </div>
  `;
  stageArea.appendChild(container);
  document.getElementById("kw4Btn").addEventListener("click", ()=>{
    const val = document.getElementById("kw4").value.trim();
    const CORRECT = "ã‚·ã‚°ãƒ"; // <-- ç·¨é›†å¯
    if(val === CORRECT){
      if(!localStorage.getItem(MAIN_STAGE_SOLVED_PREFIX + "4")){
        setTotal(getTotal() + 40);
        localStorage.setItem(MAIN_STAGE_SOLVED_PREFIX + "4","true");
      }
      // show video area and autoplay if source exists
      const wrap = document.getElementById("videoWrap");
      const vid = document.getElementById("mainVideo");
      wrap.style.display = "block";
      // try to play (if video file exists)
      vid.play().catch(()=> {
        // fallback: if video can't play (no file), just show story block then advance
        playStorySequence([BLOCK_STAGE4_AFTER_VIDEO], ()=> setMainStage(5));
      });
      // when video ends, advance to stage5
      vid.onended = () => {
        playStorySequence([BLOCK_STAGE4_AFTER_VIDEO], ()=> setMainStage(5));
      };
    } else {
      document.getElementById("kw4Res").textContent = "ä½•ã‹ãŒé•ã†ã‚ˆã†ã§ã™ã€‚";
      setTimeout(()=>document.getElementById("kw4Res").textContent = "",1500);
    }
  });
}

/* Stage5: video replay and final keyword -> final story -> complete.html */
function renderStage5(){
  const container = document.createElement("div"); container.className="stage";
  container.innerHTML = `
    <h3>ãƒ¡ã‚¤ãƒ³ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆç¬¬5æ®µéšï¼‰ â€” çœŸå®Ÿã®é¡•ç¾</h3>
    <div class="desc">å…ˆç¨‹æµã‚ŒãŸæ˜ åƒã‚’å†ç”Ÿã§ãã¾ã™ã€‚æ¦‚è¦ã‚‚ç¢ºèªã—ã€æœ€å¾Œã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
    <div style="margin-top:10px">
      <div style="margin-bottom:10px; font-weight:700">æ¦‚è¦ï¼šæ˜ åƒã®ä¸­ã«ã‚ã‚‹ã€Œæœ€å¾Œã®å°ã€ã‚’è¦‹ã¤ã‘ã‚ˆã€‚</div>
      <div style="margin-top:6px"><video id="replayVideo" controls playsinline style="width:100%; border-radius:8px"><source src="video/sample.mp4" type="video/mp4">å‹•ç”»ãŒã‚ã‚Šã¾ã›ã‚“</video></div>
      <div style="margin-top:12px" class="kinput"><input id="kw5" placeholder="æœ€çµ‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"><button id="kw5Btn">åˆ¤å®š</button></div>
      <div id="kw5Res" style="margin-top:8px;color:#ffd6d6"></div>
    </div>
  `;
  stageArea.appendChild(container);
  document.getElementById("kw5Btn").addEventListener("click", ()=>{
    const val = document.getElementById("kw5").value.trim();
    const CORRECT = "ã‚ªãƒ¡ã‚¬"; // <-- ç·¨é›†å¯
     if(val === CORRECT){
      if(!localStorage.getItem(MAIN_STAGE_SOLVED_PREFIX + "5")){
        setTotal(getTotal() + 50);
        localStorage.setItem(MAIN_STAGE_SOLVED_PREFIX + "5","true");
      }
      // final story then go to complete page
      playStorySequence([BLOCK_STAGE5_CORRECT], ()=> {
        location.href = "complete.html";
      });
    } else {
      document.getElementById("kw5Res").textContent = "ä½•ã‹ãŒé•ã†ã‚ˆã†ã§ã™ã€‚";
      setTimeout(()=>document.getElementById("kw5Res").textContent = "",1500);
    }
  });
}

/* ============================
  Story / Typewriter utilities
  - playStorySequence(blocksArray, callback)
  - typewriter outputs to #storyText
============================ */
const storyTextEl = document.getElementById("storyText");

let storyQueue = [];
let isTyping = false;

function typeWriter(text, speed=18, cb){
  // speed: ms per char (18 is moderate). Increase for slower.
  let i=0;
  storyTextEl.textContent = "";
  isTyping = true;
  function step(){
    if(i < text.length){
      storyTextEl.textContent += text.charAt(i);
      i++;
      setTimeout(step, speed);
    } else {
      isTyping = false;
      if(cb) cb();
    }
  }
  step();
}

function playStorySequence(blocks, finalCallback){
  // blocks: array of strings to display sequentially (each displayed fully)
  // When playing, we disable other interactions to avoid double-triggers (simple approach)
  if(!blocks || blocks.length===0){ if(finalCallback) finalCallback(); return; }
  // chain them
  let idx=0;
  function next(){
    if(idx >= blocks.length){ if(finalCallback) finalCallback(); return; }
    const txt = blocks[idx];
    typeWriter(txt, 18, ()=> {
      idx++;
      // short pause then next
      setTimeout(next, 600);
    });
  }
  next();
}

/* auto-play intro on load */
window.addEventListener("load", ()=>{
  // render UI
  renderStage();
  // show initial intro story on page load
  // if you don't want it to autoplay every page load, you can gate with a flag in localStorage
  if(!localStorage.getItem("intro_shown")){
    playStorySequence([STORY_INTRO], ()=> {
      localStorage.setItem("intro_shown","true");
    });
  } else {
    // show a short placeholder or keep it blank
    storyTextEl.textContent = "";
  }
});

/* ============================
  Initialization and helpers
============================ */
renderStage();
renderTotal();

/* update total and mission marks when returning from mission page */
window.addEventListener("visibilitychange", ()=>{
  if(!document.hidden){
    renderTotal();
    renderNormalMissions();
    renderStage(); // in case main stage flags changed
  }
});
</script>
</body>
</html>
